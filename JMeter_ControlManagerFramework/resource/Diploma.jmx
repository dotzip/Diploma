<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2" properties="3.2" jmeter="3.3 r1808647">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="Test Plan" enabled="true">
      <stringProp name="TestPlan.comments"></stringProp>
      <boolProp name="TestPlan.functional_mode">false</boolProp>
      <boolProp name="TestPlan.serialize_threadgroups">false</boolProp>
      <elementProp name="TestPlan.user_defined_variables" elementType="Arguments" guiclass="ArgumentsPanel" testclass="Arguments" testname="User Defined Variables" enabled="true">
        <collectionProp name="Arguments.arguments"/>
      </elementProp>
      <stringProp name="TestPlan.user_define_classpath"></stringProp>
    </TestPlan>
    <hashTree>
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="Thread Group" enabled="true">
        <stringProp name="ThreadGroup.on_sample_error">continue</stringProp>
        <elementProp name="ThreadGroup.main_controller" elementType="LoopController" guiclass="LoopControlPanel" testclass="LoopController" testname="Loop Controller" enabled="true">
          <boolProp name="LoopController.continue_forever">false</boolProp>
          <stringProp name="LoopController.loops">1</stringProp>
        </elementProp>
        <stringProp name="ThreadGroup.num_threads">1</stringProp>
        <stringProp name="ThreadGroup.ramp_time">1</stringProp>
        <longProp name="ThreadGroup.start_time">1518442030000</longProp>
        <longProp name="ThreadGroup.end_time">1518442030000</longProp>
        <boolProp name="ThreadGroup.scheduler">false</boolProp>
        <stringProp name="ThreadGroup.duration"></stringProp>
        <stringProp name="ThreadGroup.delay"></stringProp>
      </ThreadGroup>
      <hashTree>
        <JSR223Sampler guiclass="TestBeanGUI" testclass="JSR223Sampler" testname="New Application" enabled="true">
          <stringProp name="cacheKey"></stringProp>
          <stringProp name="filename"></stringProp>
          <stringProp name="parameters"></stringProp>
          <stringProp name="script">import org.openqa.selenium.By
import org.openqa.selenium.Keys
import org.openqa.selenium.WebDriver
import org.openqa.selenium.chrome.ChromeDriver
import org.apache.jmeter.samplers.SampleResult
import org.openqa.selenium.support.ui.Select
import org.openqa.selenium.support.ui.ExpectedConditions
import org.openqa.selenium.support.ui.WebDriverWait
import java.util.concurrent.TimeUnit

def ctrlManager = vars.getObject(&quot;CTRL_MANAGER&quot;)
def driver = vars.getObject(&quot;DRIVER&quot;)

//New application
driver.findElement(By.xpath(&quot;//ul[@id=&apos;menu&apos;]/li[2]&quot;)).click()
driver.findElement(By.xpath(&quot;//ul[@id=&apos;menu&apos;]/li[2]/ul/li[1]&quot;)).click()

/*Fill data*/

//SELECT
ctrlManager.selectCtrl(&quot;ApplicationTypeRbg&quot;)
//TEXT FIELD
ctrlManager.textCtrl(&quot;SurnameTxt&quot;)
ctrlManager.textCtrl(&quot;ForenameTxt&quot;)
//DATE
ctrlManager.dateCtrl(&quot;id2b&quot;)
//TEXT
ctrlManager.textCtrl(&quot;identificationCardNo&quot;)
//RADIO
ctrlManager.radioButtonCtrl(&quot;ProofOfAddressRbg&quot;)
ctrlManager.radioButtonCtrl(&quot;ProofOfIncomeRbg&quot;)
ctrlManager.radioButtonCtrl(&quot;PaymentProtectionRbg&quot;)
//BUTTON
ctrlManager.buttonCtrl(&quot;nav1Btn&quot;)


</stringProp>
          <stringProp name="scriptLanguage">groovy</stringProp>
        </JSR223Sampler>
        <hashTree>
          <JSR223PreProcessor guiclass="TestBeanGUI" testclass="JSR223PreProcessor" testname="Login PreProcessor" enabled="true">
            <stringProp name="scriptLanguage">groovy</stringProp>
            <stringProp name="parameters"></stringProp>
            <stringProp name="filename"></stringProp>
            <stringProp name="cacheKey"></stringProp>
            <stringProp name="script">import org.openqa.selenium.By
import org.openqa.selenium.WebDriver
import org.openqa.selenium.chrome.ChromeDriver
import org.apache.jmeter.samplers.SampleResult
import org.openqa.selenium.support.ui.ExpectedConditions
import org.openqa.selenium.support.ui.WebDriverWait
import java.util.concurrent.TimeUnit

/**
 * @System.setProperty for browser
 * @WebDriver object for browser management
 * @SampleResult for timestamps
 */

System.setProperty(&quot;webdriver.chrome.driver&quot;, &quot;C:\\\Users\\\c22466a\\\Documents\\\Diploma\\\apache-jmeter-3.3\\\browser_drivers\\\chromedriver.exe&quot;)

WebDriver driver = new ChromeDriver()
SampleResult result = new SampleResult()
WebDriverWait driverWait = new WebDriverWait(driver, 60)

driver.manage().timeouts().implicitlyWait(60, TimeUnit.SECONDS)

log.info(&quot;=== Login sampler ===&quot;)

driver.get(&quot;http://sso.experian.local:8080/sso/UI/Login?realm=TENANT1&quot;)
driver.findElement(By.id(&quot;IDToken1&quot;)).click()
driver.findElement(By.id(&quot;IDToken1&quot;)).sendKeys(&quot;john&quot;)
driver.findElement(By.id(&quot;IDToken2&quot;)).click()
driver.findElement(By.id(&quot;IDToken2&quot;)).sendKeys(&quot;Admin123!&quot;)

def timeStamp = result.timeStamp
result.sampleStart()
driver.findElement(By.name(&quot;Login.Submit&quot;)).click()
driverWait.until(ExpectedConditions.elementToBeClickable(By.xpath(&quot;//ul[@id=&apos;menu&apos;]/li[2]&quot;))) // waiting when homepage will be load
result.sampleEnd()

def subResult = new SampleResult(timeStamp, result.endTime - result.startTime)
subResult.setSampleLabel(&quot;TIME LOADING LOGIN PAGE&quot;)
result.addRawSubResult(subResult)

log.info(&quot;Login&apos;s time: ${(result.endTime - result.startTime) / 1000} seconds&quot;)

log.info(&quot;=== End ===&quot;)

vars.putObject(&quot;DRIVER&quot;, driver)
vars.putObject(&quot;RESULT&quot;, result)
vars.putObject(&quot;DRIVER_WAIT&quot;, driverWait)
</stringProp>
          </JSR223PreProcessor>
          <hashTree/>
          <JSR223PreProcessor guiclass="TestBeanGUI" testclass="JSR223PreProcessor" testname="Control Manager PreProcessor" enabled="true">
            <stringProp name="scriptLanguage">groovy</stringProp>
            <stringProp name="parameters"></stringProp>
            <stringProp name="filename"></stringProp>
            <stringProp name="cacheKey"></stringProp>
            <stringProp name="script">import org.openqa.selenium.By
import org.openqa.selenium.Keys
import org.openqa.selenium.WebDriver
import org.openqa.selenium.StaleElementReferenceException
import org.openqa.selenium.support.ui.ExpectedConditions
import org.openqa.selenium.support.ui.Select
import org.openqa.selenium.support.ui.WebDriverWait
import org.apache.poi.hssf.usermodel.HSSFRow
import org.apache.poi.hssf.usermodel.HSSFSheet
import org.apache.poi.hssf.usermodel.HSSFWorkbook
import java.util.concurrent.TimeUnit

class DataPoolExtractor {
    private String dataPoolFilePath_
    private HSSFWorkbook workbook_
    private HSSFSheet sheet_
    private int customerColumnIndex_
    private int controlsListIndex_
    private int sheetSize_


    DataPoolExtractor(String dataPoolFilePath){
        this.dataPoolFilePath_ = dataPoolFilePath
        this.workbook_ = new HSSFWorkbook(new FileInputStream(dataPoolFilePath_))
    }

    void sheetLoader(String sheetName){
        this.sheet_ = workbook_.getSheet(sheetName)
        this.sheetSize_ = sheet_.lastRowNum
    }

    void controlsListLoader(String controlsListIndex){
        HSSFRow topRow = sheet_.getRow(0)
        topRow.each { cell -&gt;
            if (cell.stringCellValue.equals(controlsListIndex)) {
                this.controlsListIndex_ = cell.getColumnIndex()
            }
        }
    }

    void customerLoader(String customerCellID) {
        HSSFRow topRow = sheet_.getRow(0)
        topRow.each { cell -&gt;
            if (cell.stringCellValue.equals(customerCellID)) {
                this.customerColumnIndex_ = cell.getColumnIndex()
            }
        }
    }

    String getStringDataRecord(String controlID) {
        try {
            for (int i = 0; i &lt; sheetSize_; i++) {
                HSSFRow row = sheet_.getRow(i)
                if (row.getCell(controlsListIndex_).stringCellValue == controlID) {
                    return row.getCell(customerColumnIndex_).stringCellValue
                }
            }
        }catch (Exception ex){
            print ex.getMessage()
        }
    }
}

class ControlManager {
    private WebDriverWait driverWait_
    private WebDriver driver_
    private DataPoolExtractor xls_
    private final int noAttempts_ = 15
    private def log_

    ControlManager(WebDriver driver, WebDriverWait driverWait, DataPoolExtractor xls, def log){
        this.driverWait_ = driverWait
        this.driver_ = driver
        this.xls_ = xls
        this.log_ = log
    }

    void waitActive(){
        driver_.manage().timeouts().implicitlyWait(0, TimeUnit.SECONDS)
        driverWait_.until(ExpectedConditions.invisibilityOfElementLocated(By.className(&apos;ajax_loader&apos;)))
        driver_.manage().timeouts().implicitlyWait(30, TimeUnit.SECONDS)
    }

    void moveTo(def field, boolean scroll){
        driver_.executeScript(&quot;arguments[0].scrollIntoView($scroll);&quot;, field)
    }

    def reGetControl(String controlID){
        driverWait_.until(ExpectedConditions.visibilityOfElementLocated(By.id(controlID)))
        def field = driver_.findElement(By.id(controlID))
        moveTo(field, true)
        return field
    }

    def reGetControlXPath(String controlID, String controlXPath){
        driverWait_.until(ExpectedConditions.visibilityOfElementLocated(By.id(controlID)))
        def field = driver_.findElement(By.xpath(controlXPath))
        moveTo(field, true)
        return field
    }

    def preCtrl(String controlID){
        driver_.manage().timeouts().implicitlyWait(60, TimeUnit.SECONDS)
        driverWait_.until(ExpectedConditions.visibilityOfElementLocated(By.id(controlID)))
        def field = driver_.findElement(By.id(controlID))
        moveTo(field, false)
        /* Subsample time */
        waitActive()
        return field
    }

    def preCtrlXPath(String controlID, String controlXPath){
        driver_.manage().timeouts().implicitlyWait(60, TimeUnit.SECONDS)
        driverWait_.until(ExpectedConditions.visibilityOfElementLocated(By.id(controlID)))
        def field = driver_.findElement(By.xpath(controlXPath))
        moveTo(field, false)
        /* Subsample time */
        waitActive()
        return field
    }

    void selectCtrl(String controlID){
        log_.info(&quot;=== SELECT $controlID: ${xls_.getStringDataRecord(controlID)} ===&quot;)
        def field = preCtrl(controlID)
        def select = new Select(field)
        def attempt = 0
        def exceptionFlag = false

        driver_.manage().timeouts().implicitlyWait(0, TimeUnit.SECONDS)
        while (attempt &lt; noAttempts_) {
            try {
                exceptionFlag = false
                select.selectByVisibleText(xls_.getStringDataRecord(controlID))
            } catch (Exception err) {
                exceptionFlag = true
                attempt++
                log_.info(&quot;=== SELECT ATTEMPTS: $attempt ===&quot;)
                field = reGetControl(controlID)
                select = new Select(field)
            } finally {
                if (!exceptionFlag) attempt = noAttempts_
            }
        }
    }

    void textCtrl(String controlID){
        log_.info(&quot;=== TEXT $controlID: ${xls_.getStringDataRecord(controlID)} ===&quot;)
        def field = preCtrl(controlID)
        def attempt = 0
        def exceptionFlag = false

        driver_.manage().timeouts().implicitlyWait(0, TimeUnit.SECONDS)
        while (attempt &lt; noAttempts_) {
            try {
                exceptionFlag = false
                field.click()
                field.sendKeys(xls_.getStringDataRecord(controlID))
            } catch (Exception err) {
                exceptionFlag = true
                attempt++
                log_.info(&quot;=== TEXT ATTEMPTS: $attempt ===&quot;)
                field = reGetControl(controlID)
            } finally {
                if (!exceptionFlag) attempt = noAttempts_
            }
        }
    }

    void dateCtrl(String controlID){
        log_.info(&quot;=== DATE $controlID: ${xls_.getStringDataRecord(controlID)} ===&quot;)
        def field = preCtrl(controlID)
        def attempt = 0
        def exceptionFlag = false

        driver_.manage().timeouts().implicitlyWait(0, TimeUnit.SECONDS)
        while (attempt &lt; noAttempts_) {
            try {
                exceptionFlag = false
                field.click()
                field.sendKeys(xls_.getStringDataRecord(controlID))
                field.sendKeys(Keys.TAB)
            } catch (Exception err) {
                exceptionFlag = true
                attempt++
                log_.info(&quot;=== DATE ATTEMPTS: $attempt ===&quot;)
                field = reGetControl(controlID)
            } finally {
                if (!exceptionFlag) attempt = noAttempts_
            }
        }
    }

    void radioButtonCtrl(String controlID){
        log_.info(&quot;=== RADIO $controlID: ${xls_.getStringDataRecord(controlID)} ===&quot;)
        if(xls_.getStringDataRecord(controlID) == &apos;Yes&apos;){
            def field = preCtrlXPath(controlID, &quot;//div[@id=&apos;&quot;+controlID+&quot;&apos;]/*/label[text()=&apos;Yes&apos;]&quot;)
            def attempt = 0
            def exceptionFlag = false

            driver_.manage().timeouts().implicitlyWait(0, TimeUnit.SECONDS)
            while (attempt &lt; noAttempts_) {
                try {
                    exceptionFlag = false
                    field.click()
                } catch (Exception err) {
                    exceptionFlag = true
                    attempt++
                    log_.info(&quot;=== RADIO ATTEMPTS: $attempt ===&quot;)
                    field = reGetControlXPath(controlID, &quot;//div[@id=&apos;&quot;+controlID+&quot;&apos;]/*/label[text()=&apos;Yes&apos;]&quot;)
                } finally {
                    if (!exceptionFlag) attempt = noAttempts_
                }
            }
        }
    }

    void checkBoxCtrl(){}

    void buttonCtrl(String controlID){
        log_.info(&quot;=== BUTTON $controlID ===&quot;)
        def field = preCtrl(controlID)
        def attempt = 0
        def exceptionFlag = false

        driver_.manage().timeouts().implicitlyWait(0, TimeUnit.SECONDS)
        while (attempt &lt; noAttempts_) {
            try {
                exceptionFlag = false
                field.click()
            } catch (Exception err) {
                exceptionFlag = true
                attempt++
                log_.info(&quot;=== BUTTON ATTEMPTS: $attempt ===&quot;)
                field = reGetControl(controlID)
            } finally {
                if (!exceptionFlag) attempt = noAttempts_
            }
        }
    }
}

def driver = vars.getObject(&quot;DRIVER&quot;)
def driverWait = vars.getObject(&quot;DRIVER_WAIT&quot;)
DataPoolExtractor xls = new DataPoolExtractor(&quot;C:\\\Users\\\c22466a\\\Documents\\\Diploma\\\tc-pco-create-app.xls&quot;)
xls.sheetLoader(&quot;MY_INPUTS&quot;)
xls.controlsListLoader(&quot;Field&quot;)
xls.customerLoader(&quot;TC1&quot;)

ControlManager ctrlManager = new ControlManager(driver, driverWait, xls, log)

vars.putObject(&quot;CTRL_MANAGER&quot;, ctrlManager)

</stringProp>
          </JSR223PreProcessor>
          <hashTree/>
        </hashTree>
        <ResultCollector guiclass="TableVisualizer" testclass="ResultCollector" testname="View Results in Table" enabled="true">
          <boolProp name="ResultCollector.error_logging">false</boolProp>
          <objProp>
            <name>saveConfig</name>
            <value class="SampleSaveConfiguration">
              <time>true</time>
              <latency>true</latency>
              <timestamp>true</timestamp>
              <success>true</success>
              <label>true</label>
              <code>true</code>
              <message>true</message>
              <threadName>true</threadName>
              <dataType>true</dataType>
              <encoding>false</encoding>
              <assertions>true</assertions>
              <subresults>true</subresults>
              <responseData>false</responseData>
              <samplerData>false</samplerData>
              <xml>false</xml>
              <fieldNames>true</fieldNames>
              <responseHeaders>false</responseHeaders>
              <requestHeaders>false</requestHeaders>
              <responseDataOnError>false</responseDataOnError>
              <saveAssertionResultsFailureMessage>true</saveAssertionResultsFailureMessage>
              <assertionsResultsToSave>0</assertionsResultsToSave>
              <bytes>true</bytes>
              <sentBytes>true</sentBytes>
              <threadCounts>true</threadCounts>
              <idleTime>true</idleTime>
              <connectTime>true</connectTime>
            </value>
          </objProp>
          <stringProp name="filename"></stringProp>
        </ResultCollector>
        <hashTree/>
      </hashTree>
    </hashTree>
    <WorkBench guiclass="WorkBenchGui" testclass="WorkBench" testname="WorkBench" enabled="true">
      <boolProp name="WorkBench.save">true</boolProp>
    </WorkBench>
    <hashTree/>
  </hashTree>
</jmeterTestPlan>
